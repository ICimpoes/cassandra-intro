# Cassandra
Cassandra is massively linearly scalable NoSQL database.

  - Fully distributed, with no single point of failure
  - Free and open source
  - Highly performant, with near-linear horizontal scaling in proper use cases

### Cassandra Query Language(CQL)
Cassandra models data using CQL.
CQL provides a familiar, row-column, SQL-like approach
  * CREATE, ALTER, DROP
  * SELECT, INSERT, UPDATE, DELETE

```SQL
CREATE TABLE Performer (
  name VARCHAR,
  country VARCHAR,
  style VARCHAR,
  born INT,
  died INT,
  PRIMARY KEY (name)
);
```

## Internal architecture

### Cluster
Cluster is a peer to peer (no master, no slaves) set of nodes.
  * **Node** - one Cassandra instance
  * **Rack** - a logical set of of physically related nodes (availability zone)
  * **Datacenter** - a logical set of racks
  * **Cluster** - the full set of nodes which map to a single complete token ring

![alt text](/img/cassandra-cluster.jpg "Cassandra cluster")

### Coordinator

Coordinator is the node chosen by the client to receive a particular read or write request to its cluster.  
**Any** node can coordinate **any** request.

  * The coordinator manages the Replication Factor
  * The coordinator applies the Consistency Level

![alt text](/img/cassandra-coordinator.jpg "Cassandra coordinator")

### Consistent hashing

Data is stored on nodes in partitions, each identified by a unique token.
  * **Partition** - a storage location on a node (analogous to a "table row")
  * **Token** - integer value generated by a hashing algorithm, identifying a partition's location within a cluster

#### What is the partitioner?
Imagine a 0 to 100 token range (instead of -2^63 to +2^63).

  * Each node is assigned a token, just like each of its partitions

A node's partitioner hashes a token from the partition key value of a write request.

Ex:
```SQL
CREATE TABLE Users (
    firstname text,
    lastname text,
    level text,
    PRIMARY KEY ((lastname, firstname))
);
```
Here ```(lastname, firstname)``` is *partition key*
```SQL
INSERT INTO Users (firstname, lastname, level)
    VALUES ('Oscar', 'Orange', 42);
```
What happens:
![alt text](/img/cassandra-partitioner.jpg "Cassandra partitioner")

### Data replication
**Replication factor** - how many replicas(copy of the data) to make of each partition.  
Replication factor is configured when a keyspace is created.
  * **SimpleStrategy** - one factor for entire cluster
    
    ```SQL
    CREATE KEYSPACE simple-demo
    WITH REPLICATION =
        {'class':'SimpleStrategy', 'replication_factor':2}
    ```
  * **NetworkTopologyStrategy**  - separate factor for each data center in cluster
    
    ```SQL
    CREATE KEYSPACE simple-demo
    WITH REPLICATION =
        {'class':'NetworkTopologyStrategy', 'dc-east':2, 'dc-west':3}
    ```
### Consistency

  * **Consistency Level** - sets how many of the nodes to be sent a given request must *acknowledge* that request, for a response to be returned to the client
  * **Write request** - how many nodes must acknowledge they received and wrote the write request
  * **Read request** - how many nodes must acknowledge by sending their most recent copy of the data
  * **Immediate Consistency** - reads always return the most recent data
  * **Eventual Consistency** - reads may return stale data

In Cassandra you can set up *Consistency Level (CL)* for every request.
```Java
if (nodes_written + nodes_read) > RF { immediate consistency }
```
Some of the available *CL*

| Name | Description |
| --- | --- |
| ANY (writes only) | Write to any node. |
| ALL | Check all nodes. Fail if any is down. |
| ONE (TWO, THREE) | Check closest node to coordinator. |
| QUORUM | Check quorum (RF/2 + 1) of available nodes. |

In Cassandra clock synchronization across nodes is critical because
  * Every write to any column includes column name, column value, and timestamp since epoch (1/1/70)
  * The most recently written data is returned to the client
